<!DOCTYPE html>
<html>
<head>
    <title>HelioAPI Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #0F2537 0%, #1A3A52 50%, #2C5F7C 100%);
            min-height: 100vh;
            padding: 20px; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        h1 { 
            color: #FFFFFF; 
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 800;
        }
        
        h2 {
            color: #1A3A52;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid rgba(79, 179, 191, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(79, 179, 191, 0.2);
        }
        
        .stat-card h3 { 
            color: #666; 
            font-size: 14px; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .stat-card .value { 
            font-size: 2.5rem; 
            font-weight: 800; 
            background: linear-gradient(135deg, #FF8C42 0%, #4FB3BF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
            border: 2px solid rgba(79, 179, 191, 0.2);
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #1A3A52; 
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #E5E7EB; 
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #4FB3BF;
        }
        
        button { 
            background: #FF8C42; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        button:hover { 
            background: #E67A2E;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 140, 66, 0.3);
        }
        
        .api-key-list { 
            margin-top: 20px; 
        }
        
        .api-key-item { 
            background: #F9FAFB; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #4FB3BF;
            transition: all 0.3s ease;
        }
        
        .api-key-item:hover {
            box-shadow: 0 4px 8px rgba(79, 179, 191, 0.2);
        }
        
        .tier-badge { 
            display: inline-block; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tier-starter { 
            background: #9FD356; 
            color: #1A3A52; 
        }
        
        .tier-professional { 
            background: #4FB3BF; 
            color: #FFFFFF; 
        }
        
        .tier-enterprise { 
            background: #FF8C42; 
            color: #FFFFFF; 
        }
        
        .success { 
            background: #D1FAE5; 
            border: 2px solid #9FD356; 
            color: #065F46; 
            padding: 16px; 
            border-radius: 8px; 
            margin-top: 15px;
            font-weight: 500;
        }
        
        .error { 
            background: #FEE2E2; 
            border: 2px solid #EF4444; 
            color: #991B1B; 
            padding: 16px; 
            border-radius: 8px; 
            margin-top: 15px;
            font-weight: 500;
        }
        
        .hidden { 
            display: none; 
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 37, 55, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(79, 179, 191, 0.3);
        }
        
        .modal.hidden {
            display: none;
        }
        
        .tier-change-btn {
            background: #9FD356;
            color: #1A3A52;
            padding: 10px 18px;
            font-size: 13px;
            margin-right: 10px;
        }
        
        .tier-change-btn:hover {
            background: #8BC245;
        }
        
        .deactivate-btn {
            background: #EF4444;
        }
        
        .deactivate-btn:hover {
            background: #DC2626;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .refresh-btn {
            background: #4FB3BF;
        }
        
        .refresh-btn:hover {
            background: #3D9DA8;
        }
        
        .cancel-btn {
            background: #6B7280;
        }
        
        .cancel-btn:hover {
            background: #4B5563;
        }
        
        code {
            background: #F3F4F6;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            display: block;
            margin: 10px 0;
            word-break: break-all;
            border: 1px solid #E5E7EB;
        }
        
        .warning-box {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            color: #92400E;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="margin-bottom: 0;">üîÜ HelioAPI Admin Dashboard</h1>
        <button onclick="logout()" style="background: #EF4444;">Logout</button>
    </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total API Keys</h3>
                <div class="value" id="totalKeys">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Keys</h3>
                <div class="value" id="activeKeys">-</div>
            </div>
            <div class="stat-card">
                <h3>Starter Tier</h3>
                <div class="value" id="starterCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Professional Tier</h3>
                <div class="value" id="professionalCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Calls This Month</h3>
                <div class="value" id="totalCalls">-</div>
            </div>
        </div>
        
        <!-- Create API Key Form -->
        <div class="section">
            <h2>Create New API Key</h2>
            <form id="createKeyForm">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="companyName" required placeholder="Solar Manufacturer Co">
                </div>
                <div class="form-group">
                    <label>Tier *</label>
                    <select id="tier" required>
                        <option value="starter">Starter - 180 req/min</option>
                        <option value="professional">Professional - 250 req/min</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="contactEmail" placeholder="contact@company.com">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" rows="3" placeholder="Optional notes about this customer"></textarea>
                </div>
                <button type="submit">Generate API Key</button>
            </form>
            <div id="createResult" class="hidden"></div>
        </div>
        
        <!-- API Keys List -->
        <div class="section">
            <h2>Active API Keys</h2>
            <button onclick="loadApiKeys()" class="refresh-btn">Refresh List</button>
            <div id="apiKeysList" class="api-key-list"></div>
        </div>
    </div>
    
    <!-- Tier Update Modal -->
    <div id="tierModal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #1A3A52;">Update Tier</h2>
            <div id="tierModalContent" style="margin-bottom: 20px;"></div>
            <div class="form-group">
                <label>New Tier:</label>
                <select id="newTier">
                    <option value="starter">Starter - 180 req/min</option>
                    <option value="professional">Professional - 250 req/min</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reason (optional):</label>
                <input type="text" id="tierChangeReason" placeholder="e.g., Customer requested upgrade">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="confirmTierUpdate()" class="tier-change-btn">Confirm Update</button>
                <button onclick="closeTierModal()" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://helioapi-production.up.railway.app';
        
        // Get token from localStorage
        const ADMIN_TOKEN = localStorage.getItem('helioAdminToken');
        
        const headers = {
            'Authorization': `Bearer ${ADMIN_TOKEN}`,
            'Content-Type': 'application/json'
        };
        
        let currentApiKeyForTierUpdate = null;
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('helioAdminToken');
                window.location.href = 'index.html';
            }
        }
        
        // Load dashboard stats
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard`, { headers });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalKeys').textContent = data.summary.total_api_keys;
                    document.getElementById('activeKeys').textContent = data.summary.active_keys;
                    document.getElementById('starterCount').textContent = data.summary.keys_by_tier.starter || 0;
                    document.getElementById('professionalCount').textContent = data.summary.keys_by_tier.professional || 0;
                    document.getElementById('totalCalls').textContent = data.summary.total_calls_this_month.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Create API key
        document.getElementById('createKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyName = document.getElementById('companyName').value;
            const tier = document.getElementById('tier').value;
            const contactEmail = document.getElementById('contactEmail').value;
            const notes = document.getElementById('notes').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/api-keys/create`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        company_name: companyName,
                        tier: tier,
                        contact_email: contactEmail || null,
                        notes: notes || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const resultDiv = document.getElementById('createResult');
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ API Key Created Successfully!</h3>
                        <p><strong>Company:</strong> ${data.company_name}</p>
                        <p><strong>Tier:</strong> ${data.tier}</p>
                        <p><strong>API Key:</strong> <code style="background:#fff;padding:8px;display:block;margin:10px 0;font-size:14px;word-break:break-all;">${data.api_key}</code></p>
                        <p style="color:#856404;background:#fff3cd;padding:10px;border-radius:4px;margin-top:10px;">
                            ‚ö†Ô∏è <strong>Important:</strong> Save this API key now! It won't be shown again.
                        </p>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Reset form
                    document.getElementById('createKeyForm').reset();
                    
                    // Reload dashboard
                    loadDashboard();
                    loadApiKeys();
                } else {
                    showError('Failed to create API key: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        });
        
        // Load API keys list with tier change buttons
        async function loadApiKeys() {
            try {
                const response = await fetch(`${API_BASE}/admin/api-keys/list?limit=50`, { headers });
                const data = await response.json();
                
                const listDiv = document.getElementById('apiKeysList');
                
                if (data.success && data.api_keys.length > 0) {
                    listDiv.innerHTML = data.api_keys.map(key => `
                        <div class="api-key-item">
                            <div style="display:flex;justify-content:space-between;align-items:start;gap:20px;">
                                <div style="flex:1;">
                                    <h3 style="margin-bottom:5px;">${key.company_name}</h3>
                                    <span class="tier-badge tier-${key.tier}">${key.tier.toUpperCase()}</span>
                                    <p style="margin-top:10px;color:#666;font-size:13px;">
                                        <strong>Key:</strong> ${key.api_key_preview}<br>
                                        <strong>Created:</strong> ${new Date(key.created_at).toLocaleDateString()}<br>
                                        <strong>Calls This Month:</strong> ${key.calls_this_month || 0}<br>
                                        ${key.contact_email ? `<strong>Email:</strong> ${key.contact_email}<br>` : ''}
                                        ${key.last_used_at ? `<strong>Last Used:</strong> ${new Date(key.last_used_at).toLocaleDateString()}<br>` : ''}
                                        ${key.notes ? `<strong>Notes:</strong> ${key.notes.substring(0, 100)}${key.notes.length > 100 ? '...' : ''}` : ''}
                                    </p>
                                </div>
                                <div class="button-group" style="flex-shrink:0;">
                                    <button onclick="openTierModal('${key.api_key_preview}', '${key.company_name.replace(/'/g, "\\'")}', '${key.tier}')" 
                                            class="tier-change-btn">
                                        Change Tier
                                    </button>
                                    <button onclick="deactivateKey('${key.api_key_preview}')" 
                                            style="background:#dc3545;">
                                        Deactivate
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p style="color:#666;padding:20px;">No API keys found.</p>';
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }
        
        // Open tier update modal
        function openTierModal(apiKeyPreview, companyName, currentTier) {
            currentApiKeyForTierUpdate = apiKeyPreview;
            
            document.getElementById('tierModalContent').innerHTML = `
                <div style="background:#f8f9fa;padding:15px;border-radius:4px;border-left:4px solid #1f4e79;">
                    <p style="margin-bottom:10px;">
                        <strong>Company:</strong> ${companyName}
                    </p>
                    <p>
                        <strong>Current Tier:</strong> 
                        <span class="tier-badge tier-${currentTier}" style="margin-left:8px;">${currentTier.toUpperCase()}</span>
                    </p>
                </div>
            `;
            
            // Set current tier as selected
            document.getElementById('newTier').value = currentTier;
            document.getElementById('tierChangeReason').value = '';
            
            document.getElementById('tierModal').classList.remove('hidden');
        }
        
        // Close tier modal
        function closeTierModal() {
            document.getElementById('tierModal').classList.remove('hidden');
            document.getElementById('tierModal').classList.add('hidden');
            currentApiKeyForTierUpdate = null;
        }
        
        // Confirm tier update
        async function confirmTierUpdate() {
            const newTier = document.getElementById('newTier').value;
            const reason = document.getElementById('tierChangeReason').value;
            
            if (!currentApiKeyForTierUpdate) {
                alert('Error: No API key selected');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    new_tier: newTier
                });
                if (reason) params.append('reason', reason);
                
                const response = await fetch(
                    `${API_BASE}/admin/api-keys/preview/${currentApiKeyForTierUpdate}/update-tier?${params}`,
                    {
                        method: 'PUT',
                        headers
                    }
                );
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Tier Updated Successfully!\n\nCompany: ${data.company_name}\nChange: ${data.old_tier} ‚Üí ${data.new_tier}`);
                    closeTierModal();
                    loadDashboard();
                    loadApiKeys();
                } else {
                    alert('‚ùå Failed to update tier: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                alert('‚ùå Network error: ' + error.message);
            }
        }
        
        // Deactivate API key (placeholder - needs backend endpoint)
        async function deactivateKey(apiKeyPreview) {
    const confirmed = confirm(
        `‚ö†Ô∏è Are you sure you want to deactivate this API key?\n\n` +
        `Key: ${apiKeyPreview}\n\n` +
        `This will immediately stop all API requests.`
    );

    if (!confirmed) {
        return;
    }

    const reason = prompt(
        'Optional: Why are you deactivating this key?\n(e.g., "Customer cancelled")',
        ''
    );

    try {
        const params = new URLSearchParams();
        if (reason) {
            params.append('reason', reason);
        }
    
        const response = await fetch(
            `${API_BASE}/admin/api-keys/preview/${apiKeyPreview}/deactivate?${params}`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${ADMIN_TOKEN}`
                }
            }
        );
    
        const data = await response.json();
    
        if (response.ok && data.success) {
            alert(
                `‚úÖ API Key Deactivated!\n\n` +
                `Company: ${data.company_name}\n` +
                `Reason: ${data.reason}`
            );
            
            // Reload the dashboard and key list
            loadDashboard();
            loadApiKeys();
        } else {
            alert(`‚ùå Error: ${data.detail || 'Failed to deactivate'}`);
        }
    
    } catch (error) {
        alert(`‚ùå Network error: ${error.message}`);
    }
}

function showError(message) {
    const resultDiv = document.getElementById('createResult');
    resultDiv.className = 'error';
    resultDiv.textContent = message;
    resultDiv.classList.remove('hidden');
}

// Load on page load
window.addEventListener('load', () => {
    loadDashboard();
    loadApiKeys();
});
    </script>
</body>
</html>