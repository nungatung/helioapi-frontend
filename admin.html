<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelioAPI Admin Dashboard</title>
    
    <link rel="icon" type="image/png" sizes="512x512" href="green-energy.png">
    <link rel="icon" type="image/png" sizes="256x256" href="green-energy-256.png">
    <link rel="icon" type="image/png" sizes="128x128" href="green-energy-128.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'helio-orange': '#FF8C42',
                        'helio-teal': '#4FB3BF',
                        'helio-lime': '#9FD356',
                        'helio-navy': '#1A3A52',
                        'helio-dark': '#0F2537',
                        'helio-light-teal': '#6EC4CF',
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0F2537 0%, #1A3A52 50%, #2C5F7C 100%);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #FF8C42 0%, #4FB3BF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            .stat-number {
                font-size: 2.5rem;
            }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(79, 179, 191, 0.2);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8">
        
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white">
                üîÜ API Key Dashboard
            </h1>
            <button onclick="logout()" 
                    class="bg-red-500 hover:bg-red-600 text-white px-6 py-2.5 rounded-lg font-semibold transition-all hover:shadow-lg w-full sm:w-auto">
                Logout
            </button>
        </div>
        
        <!-- Stats Grid -->
        <div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="card-hover bg-white rounded-xl p-5 md:p-6 shadow-lg border-2 border-helio-teal border-opacity-20">
                <h3 class="text-xs md:text-sm text-gray-600 uppercase font-semibold tracking-wide mb-2">Total API Keys</h3>
                <div class="stat-number" id="totalKeys">-</div>
            </div>
            <div class="card-hover bg-white rounded-xl p-5 md:p-6 shadow-lg border-2 border-helio-teal border-opacity-20">
                <h3 class="text-xs md:text-sm text-gray-600 uppercase font-semibold tracking-wide mb-2">Active Keys</h3>
                <div class="stat-number" id="activeKeys">-</div>
            </div>
            <div class="card-hover bg-white rounded-xl p-5 md:p-6 shadow-lg border-2 border-helio-teal border-opacity-20">
                <h3 class="text-xs md:text-sm text-gray-600 uppercase font-semibold tracking-wide mb-2">Starter Tier</h3>
                <div class="stat-number" id="starterCount">-</div>
            </div>
            <div class="card-hover bg-white rounded-xl p-5 md:p-6 shadow-lg border-2 border-helio-teal border-opacity-20">
                <h3 class="text-xs md:text-sm text-gray-600 uppercase font-semibold tracking-wide mb-2">Professional Tier</h3>
                <div class="stat-number" id="professionalCount">-</div>
            </div>
            <div class="card-hover bg-white rounded-xl p-5 md:p-6 shadow-lg border-2 border-helio-teal border-opacity-20 sm:col-span-2 lg:col-span-1">
                <h3 class="text-xs md:text-sm text-gray-600 uppercase font-semibold tracking-wide mb-2">Calls This Month</h3>
                <div class="stat-number" id="totalCalls">-</div>
            </div>
        </div>
        
        <!-- Create API Key Form -->
        <div class="bg-white rounded-xl shadow-lg p-5 md:p-8 mb-6 md:mb-8 border-2 border-helio-teal border-opacity-20">
            <h2 class="text-xl md:text-2xl font-bold text-helio-navy mb-4 md:mb-6">Create New API Key</h2>
            <form id="createKeyForm" class="space-y-4 md:space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-helio-navy mb-2">Company Name *</label>
                    <input type="text" 
                           id="companyName" 
                           required 
                           placeholder="Solar Manufacturer Co"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-helio-navy mb-2">Tier *</label>
                    <select id="tier" 
                            required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition cursor-pointer">
                        <option value="starter">Starter - 180 req/min</option>
                        <option value="professional">Professional - 250 req/min</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-helio-navy mb-2">Contact Email</label>
                    <input type="email" 
                           id="contactEmail" 
                           placeholder="contact@company.com"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-helio-navy mb-2">Notes</label>
                    <textarea id="notes" 
                              rows="3" 
                              placeholder="Optional notes about this customer"
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition resize-none"></textarea>
                </div>
                
                <button type="submit" 
                        class="w-full sm:w-auto bg-helio-orange hover:bg-opacity-90 text-white px-8 py-3 rounded-lg font-semibold transition-all hover:shadow-lg">
                    Generate API Key
                </button>
            </form>
            
            <div id="createResult" class="hidden mt-5"></div>
        </div>
        
        <!-- API Keys List -->
        <div class="bg-white rounded-xl shadow-lg p-5 md:p-8 border-2 border-helio-teal border-opacity-20">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-5 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-helio-navy">Active API Keys</h2>
                <button onclick="loadApiKeys()" 
                        class="w-full sm:w-auto bg-helio-teal hover:bg-opacity-90 text-white px-6 py-2.5 rounded-lg font-semibold transition-all hover:shadow-lg">
                    Refresh List
                </button>
            </div>
            <div id="apiKeysList" class="space-y-4"></div>
        </div>
    </div>
    
    <!-- Tier Update Modal -->
    <div id="tierModal" class="hidden fixed inset-0 bg-helio-navy bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto border-2 border-helio-teal border-opacity-30">
            <div class="p-6 md:p-8">
                <h2 class="text-2xl font-bold text-helio-navy mb-5">Update Tier</h2>
                <div id="tierModalContent" class="mb-5"></div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-helio-navy mb-2">New Tier:</label>
                        <select id="newTier"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition cursor-pointer">
                            <option value="starter">Starter - 180 req/min</option>
                            <option value="professional">Professional - 250 req/min</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-helio-navy mb-2">Reason (optional):</label>
                        <input type="text" 
                               id="tierChangeReason" 
                               placeholder="e.g., Customer requested upgrade"
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-helio-teal focus:outline-none transition">
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 mt-6">
                    <button onclick="confirmTierUpdate()" 
                            class="w-full sm:flex-1 bg-helio-lime hover:bg-opacity-90 text-helio-navy px-6 py-3 rounded-lg font-semibold transition-all hover:shadow-lg">
                        Confirm Update
                    </button>
                    <button onclick="closeTierModal()" 
                            class="w-full sm:flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://helioapi-production.up.railway.app';
        const ADMIN_TOKEN = localStorage.getItem('helioAdminToken');
        
        const headers = {
            'Authorization': `Bearer ${ADMIN_TOKEN}`,
            'Content-Type': 'application/json'
        };
        
        let currentApiKeyForTierUpdate = null;
        
        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('helioAdminToken');
                window.location.href = 'index.html';
            }
        }
        
        // Load Dashboard Stats
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard`, { headers });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalKeys').textContent = data.summary.total_api_keys;
                    document.getElementById('activeKeys').textContent = data.summary.active_keys;
                    document.getElementById('starterCount').textContent = data.summary.keys_by_tier.starter || 0;
                    document.getElementById('professionalCount').textContent = data.summary.keys_by_tier.professional || 0;
                    document.getElementById('totalCalls').textContent = data.summary.total_calls_this_month.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Create API Key
        document.getElementById('createKeyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const companyName = document.getElementById('companyName').value;
            const tier = document.getElementById('tier').value;
            const contactEmail = document.getElementById('contactEmail').value;
            const notes = document.getElementById('notes').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/api-keys/create`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        company_name: companyName,
                        tier: tier,
                        contact_email: contactEmail || null,
                        notes: notes || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const resultDiv = document.getElementById('createResult');
                    resultDiv.className = 'bg-green-50 border-2 border-helio-lime rounded-lg p-4 md:p-5';
                    resultDiv.innerHTML = `
                        <h3 class="text-lg font-bold text-helio-navy mb-3">‚úÖ API Key Created Successfully!</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>Company:</strong> ${data.company_name}</p>
                            <p><strong>Tier:</strong> <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase ${
                                data.tier === 'starter' ? 'bg-helio-lime text-helio-navy' : 'bg-helio-teal text-white'
                            }">${data.tier}</span></p>
                            <p class="font-semibold text-helio-navy">API Key:</p>
                            <code class="block bg-white p-3 rounded border border-gray-200 text-xs break-all">${data.api_key}</code>
                        </div>
                        <div class="bg-yellow-50 border-2 border-yellow-400 text-yellow-800 p-3 rounded-lg mt-4 text-sm">
                            <strong>‚ö†Ô∏è Important:</strong> Save this API key now! It won't be shown again.
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    document.getElementById('createKeyForm').reset();
                    loadDashboard();
                    loadApiKeys();
                } else {
                    showError('Failed to create API key: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        });
        
        // Load API Keys List
        async function loadApiKeys() {
            try {
                const response = await fetch(`${API_BASE}/admin/api-keys/list?limit=50`, { headers });
                const data = await response.json();
                
                const listDiv = document.getElementById('apiKeysList');
                
                if (data.success && data.api_keys.length > 0) {
                    listDiv.innerHTML = data.api_keys.map(key => `
                        <div class="bg-gray-50 rounded-lg p-4 md:p-5 border-l-4 border-helio-teal hover:shadow-md transition-all">
                            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-bold text-helio-navy mb-2 break-words">${key.company_name}</h3>
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase mb-3 ${
                                        key.tier === 'starter' ? 'bg-helio-lime text-helio-navy' : 
                                        key.tier === 'professional' ? 'bg-helio-teal text-white' : 
                                        'bg-helio-orange text-white'
                                    }">${key.tier}</span>
                                    <div class="text-sm text-gray-600 space-y-1 break-words">
                                        <p><strong>Key:</strong> ${key.api_key_preview}</p>
                                        <p><strong>Created:</strong> ${new Date(key.created_at).toLocaleDateString()}</p>
                                        <p><strong>Calls This Month:</strong> ${(key.calls_this_month || 0).toLocaleString()}</p>
                                        ${key.contact_email ? `<p><strong>Email:</strong> ${key.contact_email}</p>` : ''}
                                        ${key.last_used_at ? `<p><strong>Last Used:</strong> ${new Date(key.last_used_at).toLocaleDateString()}</p>` : ''}
                                        ${key.notes ? `<p><strong>Notes:</strong> ${key.notes.substring(0, 100)}${key.notes.length > 100 ? '...' : ''}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row lg:flex-col gap-2 lg:flex-shrink-0">
                                    <button onclick="openTierModal('${key.api_key_preview}', '${key.company_name.replace(/'/g, "\\'")}', '${key.tier}')" 
                                            class="bg-helio-lime hover:bg-opacity-90 text-helio-navy px-4 py-2 rounded-lg font-semibold text-sm transition-all hover:shadow-md whitespace-nowrap">
                                        Change Tier
                                    </button>
                                    <button onclick="deactivateKey('${key.api_key_preview}')" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all hover:shadow-md whitespace-nowrap">
                                        Deactivate
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No API keys found.</p>';
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }
        
        // Open Tier Modal
        function openTierModal(apiKeyPreview, companyName, currentTier) {
            currentApiKeyForTierUpdate = apiKeyPreview;
            
            const tierClass = currentTier === 'starter' ? 'bg-helio-lime text-helio-navy' : 
                             currentTier === 'professional' ? 'bg-helio-teal text-white' : 
                             'bg-helio-orange text-white';
            
            document.getElementById('tierModalContent').innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-helio-teal">
                    <p class="mb-2"><strong class="text-helio-navy">Company:</strong> ${companyName}</p>
                    <p>
                        <strong class="text-helio-navy">Current Tier:</strong> 
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase ml-2 ${tierClass}">
                            ${currentTier}
                        </span>
                    </p>
                </div>
            `;
            
            document.getElementById('newTier').value = currentTier;
            document.getElementById('tierChangeReason').value = '';
            document.getElementById('tierModal').classList.remove('hidden');
        }
        
        // Close Tier Modal
        function closeTierModal() {
            document.getElementById('tierModal').classList.add('hidden');
            currentApiKeyForTierUpdate = null;
        }
        
        // Confirm Tier Update
        async function confirmTierUpdate() {
            const newTier = document.getElementById('newTier').value;
            const reason = document.getElementById('tierChangeReason').value;
            
            if (!currentApiKeyForTierUpdate) {
                alert('Error: No API key selected');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    new_tier: newTier
                });
                if (reason) params.append('reason', reason);
                
                const response = await fetch(
                    `${API_BASE}/admin/api-keys/preview/${currentApiKeyForTierUpdate}/update-tier?${params}`,
                    {
                        method: 'PUT',
                        headers
                    }
                );
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Tier Updated Successfully!\n\nCompany: ${data.company_name}\nChange: ${data.old_tier} ‚Üí ${data.new_tier}`);
                    closeTierModal();
                    loadDashboard();
                    loadApiKeys();
                } else {
                    alert('‚ùå Failed to update tier: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Network error: ' + error.message);
            }
        }
        
        // Deactivate API Key
        async function deactivateKey(apiKeyPreview) {
            const confirmed = confirm(
                `‚ö†Ô∏è Are you sure you want to deactivate this API key?\n\n` +
                `Key: ${apiKeyPreview}\n\n` +
                `This will immediately stop all API requests.`
            );

            if (!confirmed) return;

            const reason = prompt(
                'Optional: Why are you deactivating this key?\n(e.g., "Customer cancelled")',
                ''
            );

            try {
                const params = new URLSearchParams();
                if (reason) params.append('reason', reason);
            
                const response = await fetch(
                    `${API_BASE}/admin/api-keys/preview/${apiKeyPreview}/deactivate?${params}`,
                    {
                        method: 'POST',
                        headers
                    }
                );
            
                const data = await response.json();
            
                if (response.ok && data.success) {
                    alert(
                        `‚úÖ API Key Deactivated!\n\n` +
                        `Company: ${data.company_name}\n` +
                        `Reason: ${data.reason}`
                    );
                    loadDashboard();
                    loadApiKeys();
                } else {
                    alert(`‚ùå Error: ${data.detail || 'Failed to deactivate'}`);
                }
            } catch (error) {
                alert(`‚ùå Network error: ${error.message}`);
            }
        }

        function showError(message) {
            const resultDiv = document.getElementById('createResult');
            resultDiv.className = 'bg-red-50 border-2 border-red-400 text-red-800 rounded-lg p-4 text-sm font-medium';
            resultDiv.textContent = message;
            resultDiv.classList.remove('hidden');
        }

        // Initialize
        window.addEventListener('load', () => {
            loadDashboard();
            loadApiKeys();
        });
    </script>
</body>
</html>